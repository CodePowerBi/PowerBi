Es_UltimosXAnos_Trading = 
VAR FechaMaxDatos = 
    CALCULATE(
        MAX ( 'tablones_des_tabla_trading'[fecha] ),
        FILTER(
            ALL ( 'tablones_des_tabla_trading' ),
            'tablones_des_tabla_trading'[Valor] <> 0
        )
    )

// Determina trimestre de esa fecha
VAR MesMax    = MONTH( FechaMaxDatos )
VAR AnioMax   = YEAR(  FechaMaxDatos )
VAR Trimestre = INT( ( MesMax - 1 ) / 3 ) + 1

// Trimestre completo anterior
VAR TrimestrePrev = IF( Trimestre = 1, 4, Trimestre - 1 )
VAR AnioPrev      = IF( Trimestre = 1, AnioMax - 1, AnioMax )

// Último mes de ese trimestre anterior
VAR MesUltPrevTrim = 
    SWITCH(
        TrimestrePrev,
        1, 3,   // Q1 → marzo
        2, 6,   // Q2 → junio
        3, 9,   // Q3 → septiembre
        4, 12   // Q4 → diciembre
    )

// Primer día de ese mes
VAR PrimerDiaUltPrevTrim = DATE( AnioPrev, MesUltPrevTrim, 1 )

// Restamos 4 años exactos
VAR FechaThreshold = 
    DATE( YEAR(PrimerDiaUltPrevTrim) - 4, MONTH(PrimerDiaUltPrevTrim), 1 )

VAR EstaFecha = 'tablones_des_tabla_trading'[fecha]

RETURN
IF(
    EstaFecha >= FechaThreshold
    && 'tablones_des_tabla_trading'[Valor] <> 0,
    1,
    0
)


________

Es_Ultimos12Meses_Trading = 
IF(
    'tablones_des_tabla_trading'[fecha] > DATE(2020, 9, 30)
    && 'tablones_des_tabla_trading'[Valor] <> 0,
    1,
    0
)

_______

Es_Ultimos4Anios_Trading = 
VAR FechaUmbral = EDATE( _MaxFecha_Valida_Trading, -48 )  
RETURN
IF(
    'tablones_des_tabla_trading'[fecha] >= FechaUmbral
    && 'tablones_des_tabla_trading'[Valor] <> 0,
    1,
    0
)
