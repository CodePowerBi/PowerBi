TOTAL COLUMNA Celeste prueba :=
VAR FechaCtx = EOMONTH ( MAX ( 'Dates'[Date] ), 0 )
VAR ValorCtx = [Total NSFR RSF Num]

-- Último fin de trimestre con datos en informe_regulatorio <= FechaCtx
VAR FechaObjetivoIR =
    CALCULATE (
        MAX ( 'informe_regulatorio'[fecha] ),
        REMOVEFILTERS ( 'informe_regulatorio' ),
        FILTER (
            ALL ( 'informe_regulatorio'[fecha] ),
            'informe_regulatorio'[fecha] <= FechaCtx
                && MONTH ( 'informe_regulatorio'[fecha] ) IN { 3, 6, 9, 12 }
        )
    )

-- Recalcula la medida numérica en la fecha objetivo (ej. septiembre)
VAR ValorFallback =
    CALCULATE (
        [Total NSFR RSF Num],
        REMOVEFILTERS ( 'Dates' ),
        TREATAS ( { FechaObjetivoIR }, 'Dates'[Date] )
    )

VAR ValorFinal = COALESCE ( ValorCtx, ValorFallback )
RETURN
FORMAT ( ValorFinal, "0.0" ) & " bn NSFR RSF"
