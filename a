Amount_3M_Atras_Vlookup :=
VAR FechaFila =
    MAX ( 'pag7_nueva'[Effective_date] )
VAR CPFila =
    MAX ( 'pag7_nueva'[CounterpartyName] )
VAR Fecha3M =
    EDATE ( FechaFila, -3 )
VAR InicioMes3M =
    DATE ( YEAR ( Fecha3M ), MONTH ( Fecha3M ), 1 )
VAR FinMes3M =
    EOMONTH ( Fecha3M, 0 )
RETURN
COALESCE (
    CALCULATE (
        SUM ( Pag7_Top10_mensual[amount_received] ),
        FILTER (
            ALL ( Pag7_Top10_mensual ),
            -- Igualar nombre de contraparte ignorando mayÃºsculas/espacios
            TRIM ( UPPER ( Pag7_Top10_mensual[counterparty_name] ) ) =
                TRIM ( UPPER ( CPFila ) )
                && Pag7_Top10_mensual[fechha] >= InicioMes3M
                && Pag7_Top10_mensual[fechha] <= FinMes3M
        )
    ),
    0
)
