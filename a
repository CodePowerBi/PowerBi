Level2_con_TOTAL =
VAR Epig =
    SELECTEDVALUE ( 'Dicc_Epigrafes_Total'[epigrafe_front_total] )

-- Selección del filtro Assets/Liabilities, pero SIN "TOTAL"
VAR SelAL_SinTotal =
    EXCEPT (
        VALUES ( 'Dicc_Epigrafes_Total'[ASSETS O LIABILITIES] ),
        { "TOTAL" }
    )

VAR HayAL =
    COUNTROWS ( SelAL_SinTotal ) > 0

RETURN
IF (
    Epig = "TOTAL",
    CALCULATE (
        [ - Level2 ],

        -- 1) solo epígrafes que componen el TOTAL (quita 999 y los negativos si no deben entrar)
        KEEPFILTERS (
            'diccionario_epigrafes_filter_vw'[id_epigrafe]
                IN { 3134, 35, 26, 10, 22, 7, 18, 6, 13 }
        ),

        -- 2) clave: ignorar el filtro original (Assets + TOTAL) y re-aplicar solo Assets/Liabilities
        REMOVEFILTERS ( 'Dicc_Epigrafes_Total'[ASSETS O LIABILITIES] ),
        IF ( HayAL, TREATAS ( SelAL_SinTotal, 'Dicc_Epigrafes_Total'[ASSETS O LIABILITIES] ) )
    ),

    CALCULATE (
        [ - Level2 ],
        TREATAS (
            VALUES ( 'Dicc_Epigrafes_Total'[id_epigrafe] ),
            'diccionario_epigrafes_filter_vw'[id_epigrafe]
        ),

        -- mismo “parche” también para filas normales (para que Assets+TOTAL no contamine)
        REMOVEFILTERS ( 'Dicc_Epigrafes_Total'[ASSETS O LIABILITIES] ),
        IF ( HayAL, TREATAS ( SelAL_SinTotal, 'Dicc_Epigrafes_Total'[ASSETS O LIABILITIES] ) )
    )
)
