Amount_3M_Atras :=
VAR FechaSel =
    MAX ( 'pag7_nueva'[Effective_date] )           -- fecha que viene del contexto/selector
VAR Fecha3M =
    EDATE ( FechaSel, -3 )                         -- 3 meses antes
VAR InicioMes3M =
    DATE ( YEAR ( Fecha3M ), MONTH ( Fecha3M ), 1 )
VAR FinMes3M =
    EOMONTH ( Fecha3M, 0 )
VAR CPName =
    SELECTEDVALUE ( 'pag7_nueva'[CounterpartyName] )
RETURN
IF (
    NOT ISBLANK ( FechaSel ) && NOT ISBLANK ( CPName ),
    CALCULATE (
        SUM ( Pag7_Top10_mensual[amount_received] ),
        FILTER (
            ALL ( Pag7_Top10_mensual ),
            Pag7_Top10_mensual[counterparty_name] = CPName
                && Pag7_Top10_mensual[fechha] >= InicioMes3M
                && Pag7_Top10_mensual[fechha] <= FinMes3M
        )
    )
)
