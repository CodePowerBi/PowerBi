VAR MaxFechaValida =
    CALCULATE(
        MAX('tablones_des_salida_buffer'[fecha]),
        FILTER(
            ALL('tablones_des_salida_buffer'),
            'tablones_des_salida_buffer'[valor] <> 0
        )
    )

VAR MesVal = MONTH(MaxFechaValida)
VAR AnioVal = YEAR(MaxFechaValida)
VAR TrimestreActual = INT((MesVal - 1) / 3) + 1

VAR TrimestreAnterior = IF(TrimestreActual = 1, 4, TrimestreActual - 1)
VAR AnioAnterior = IF(TrimestreActual = 1, AnioVal - 1, AnioVal)

VAR UltimoMesTrimestreAnterior =
    SWITCH(
        TrimestreAnterior,
        1, 3,    // Q1 → marzo
        2, 6,    // Q2 → junio
        3, 9,    // Q3 → septiembre
        4, 12    // Q4 → diciembre
    )

VAR FechaInicio = DATE(AnioAnterior, UltimoMesTrimestreAnterior, 1)
VAR FechaFin = EOMONTH(FechaInicio, 0)

RETURN
    IF(
        'tablones_des_salida_buffer'[fecha] >= FechaInicio &&
        'tablones_des_salida_buffer'[fecha] <= FechaFin &&
        'tablones_des_salida_buffer'[valor] <> 0,
        'tablones_des_salida_buffer'[valor],
        BLANK()
    )
