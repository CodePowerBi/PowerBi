Pag7_Top10_mensual =
VAR BaseConMes =
    ADDCOLUMNS (
        'tablones_des mrf_plantilla_67',
        "fecha_mes",
            DATE ( YEAR ( 'tablones_des mrf_plantilla_67'[effective_date] ),
                   MONTH( 'tablones_des mrf_plantilla_67'[effective_date] ), 1 )
    )

-- Grupos (mes, contraparte)
VAR Grupos =
    SUMMARIZE (
        BaseConMes,
        [fecha_mes],
        'tablones_des mrf_plantilla_67'[counterparty_name]
    )

-- AÃ±adimos importes y la fecha de la FILA TOP por amount_received
VAR Agregado =
    ADDCOLUMNS (
        Grupos,
        "amount_received",
            CALCULATE ( SUM ( 'tablones_des mrf_plantilla_67'[amount_received] ) ),
        "effective_date_top",
            VAR mes  = [fecha_mes]
            VAR cpty = 'tablones_des mrf_plantilla_67'[counterparty_name]
            VAR top1 =
                TOPN (
                    1,
                    FILTER (
                        BaseConMes,
                        [fecha_mes] = mes
                        && 'tablones_des mrf_plantilla_67'[counterparty_name] = cpty
                    ),
                    'tablones_des mrf_plantilla_67'[amount_received], DESC,
                    'tablones_des mrf_plantilla_67'[effective_date], DESC
                )
            RETURN MAXX ( top1, 'tablones_des mrf_plantilla_67'[effective_date] )
    )

-- Ranking dentro de cada mes por la suma mensual
VAR ConRanking =
    ADDCOLUMNS (
        Agregado,
        "position",
            VAR mes = [fecha_mes]
            RETURN
            RANKX (
                FILTER ( Agregado, [fecha_mes] = mes ),
                [amount_received],
                ,
                DESC,
                DENSE
            )
    )

RETURN
SELECTCOLUMNS (
    FILTER ( ConRanking, [position] <= 10 ),
    "position",            [position],
    "counterparty_name",   'tablones_des mrf_plantilla_67'[counterparty_name],
    "fecha",               [effective_date_top],   -- fecha original de la fila TOP
    "amount_received",     [amount_received]
)
